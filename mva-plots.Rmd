---
title: "mva-plots"
author: "Lucy Grigoroff"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{mva-plots}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

A short tutorial of the progress in mva-plots. 

```{r load-pack, fig.show='hold', message=FALSE, warning=FALSE}
#load packages
library(sp)
library(GGally)
library(dplyr)
library(stats)
library(ggplot2)
library(roxygen2)
library(testthat)
library(ggrepel)

functionDir <- "./R/"
functionList <- list.files(path = functionDir)
for(i in functionList){
  source(paste0(functionDir,i))
}
rm(i)

```

```{r, fig.show='hold', fig.width = 7.2, fig.height = 4, message=FALSE, warning=FALSE}
# For reproducibility
set.seed(153)
```

## Prerequisites
Use data for modelling/visualisation. For previous steps please use nmr-spectra-processing, fusion, nmr-parsor, ms-parsor.

## Example Data
```{r}
ann<-local(get(load("~/OneDrive - Murdoch University/datasets/covid19/bioGune/dataElements/covid19_bioGune_PLA_ANN.daE")))
aaMeta1<-ann@obsDescr[[1]]

aa<-local(get(load(file.path("~/OneDrive - Murdoch University/datasets/covid19/bioGune/dataElements/covid19_bioGune_PLA_SPC.daE"))))
aaData<-data.frame(apply(aa@.Data,2,as.numeric)) #spc/glyc data
aaMeta2<-aa@obsDescr[[1]] #metadata from PLA_SPC.daE file

# match SpcGlyc numeric and both Annotations
aaMeta1<-aaMeta1[which(aaMeta1$sampleID %in% aaMeta2$sampleID),]
aaData<-aaData[which(aaMeta2$sampleID %in% aaMeta1$sampleID),]
aaMeta2<-aaMeta2[which(aaMeta2$sampleID %in% aaMeta1$sampleID),]

#make a final annotation file
aaMetaF<-merge(aaMeta1,
                  aaMeta2,
                  by.x ="sampleID",by.y = "sampleID")
rm(aaMeta1, aaMeta2, aa, ann)

#combine the numeric and meta data
BIOspcglyc<-cbind(aaData, aaMetaF)
rm(aaData, aaMetaF)

#Organise the data as you wish 

which(BIOspcglyc[, 1:8]=="Inf")
which(is.na(BIOspcglyc[, 1:8]))
which(is.na(BIOspcglyc$age))
unique(BIOspcglyc$sex)

unique(BIOspcglyc$group)
BIOspcglyc$covid_status<-ifelse(BIOspcglyc$group =="COVID-pos","covid", ifelse(BIOspcglyc$group=="preCOVID","control", "control"))
```




## NMR spectra pre-processing
"nmr-spectra-processing" has a few function that are useful to prepare a dataset.

For this example, we will use serum NOESY data and assume the LTR check has been done and passed all.
```{r}
da<-local(get(load("~/OneDrive - Murdoch University/datasets/covid19/bioGune/dataElements/covid19_bioGune_PLA_NMR_NOESY.daE")))
ppm<-as.numeric(da@varName)
an<-da@obsDescr[[1]]
NOESY<-da@.Data

# remove ltrs and match with BIOspcglyc
    ## note for NOESY if there is a re-runs, usually take the re-runs and discard the original
sample<-an$sampleID[which(an$sampleType=="sample")]
reruns<-sample[which(nchar(sample)>8)]
  # no reruns found
rm(sample,reruns)
    ## reduce the dimension of NOESY data and corresponding annotation (an) by finding which sampleID in annotation are also found in BIOspcglyc data sampleiD column
    ## By doing this step, ltrs are automatically removed
NOESY<-NOESY[which(an$sampleID %in% BIOspcglyc$sampleID),]
an<-an[which(an$sampleID %in% BIOspcglyc$sampleID),]

    ## BIOspcglyc has 4 more samples (rows) compared to NOESY data
    ### this may occur because ........@@@ check and update this part @@@
    # BIOspcglyc$sampleID[-which(BIOspcglyc$sampleID %in% an$sampleID)]
    #  "COV02362" "COV02371" "COV02513" "COV02521" are missing in NOESY data
    ## reduce the dimension of BIOspcglyc data
BIOspcglyc<-BIOspcglyc[which(BIOspcglyc$sampleID %in% an$sampleID),]

    # now match the order of NOESY data and its annotation as the same as BIOspcglyc.
NOESY<-NOESY[match(BIOspcglyc$sampleID,an$sampleID ),]
an<-an[match(BIOspcglyc$sampleID,an$sampleID ),]

rm(an,da)
```



