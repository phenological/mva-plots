```{r}

#Add packages to the description
usethis::use_package("colorRamps")
#remove packages from the description
desc::desc_del_dep(package = "colorRamps")

#create tests
use_test("oplsda")

#build check

library(mva.plots)
 devtools::check()

#developmental
functionDir <- "./R/"
functionList <- list.files(path = functionDir)
for(i in functionList){
  source(paste0(functionDir,i))
}


devtools::session_info()

```

#load data to test functions
```{r}
ann<-local(get(load("~/OneDrive - Murdoch University/datasets/covid19/bioGune/dataElements/covid19_bioGune_PLA_ANN.daE")))
aaMeta1<-ann@obsDescr[[1]]

aa<-local(get(load(file.path("~/OneDrive - Murdoch University/datasets/covid19/bioGune/dataElements/covid19_bioGune_PLA_SPC.daE"))))
aaData<-data.frame(apply(aa@.Data,2,as.numeric)) #spc/glyc data
aaMeta2<-aa@obsDescr[[1]] #metadata from PLA_SPC.daE file

# match SpcGlyc numeric and both Annotations
aaMeta1<-aaMeta1[which(aaMeta1$sampleID %in% aaMeta2$sampleID),]
aaData<-aaData[which(aaMeta2$sampleID %in% aaMeta1$sampleID),]
aaMeta2<-aaMeta2[which(aaMeta2$sampleID %in% aaMeta1$sampleID),]

#make a final annotation file
aaMetaF<-merge(aaMeta1,
                  aaMeta2,
                  by.x ="sampleID",by.y = "sampleID")
rm(aaMeta1, aaMeta2, aa, ann)

#combine the numeric and meta data
BIOspcglyc<-cbind(aaData, aaMetaF)
rm(aaData, aaMetaF)

#Organise the data as you wish 

which(BIOspcglyc[, 1:8]=="Inf")
which(is.na(BIOspcglyc[, 1:8]))
which(is.na(BIOspcglyc$age))
unique(BIOspcglyc$sex)

unique(BIOspcglyc$group)
BIOspcglyc$covid_status<-ifelse(BIOspcglyc$group =="COVID-pos","covid", ifelse(BIOspcglyc$group=="preCOVID","control", "control"))

library(fusion)
library(dplyr)
lipo<-local(get(load("~/OneDrive - Murdoch University/datasets/covid19/cambridgeFollowUpPart2/DataElements/covid19_cambridge_ORI_FU1_FU2_PLA_LIPO.daE")))
LIPO<-data.frame(apply(lipo@.Data,2,as.numeric))
LIPO_ANN<-lipo@obsDescr[[1]]

ann<-local(get(load("~/OneDrive - Murdoch University/datasets/covid19/cambridge/DataElements/covid19_cambridge_PLA_ANN_fix.daE")))
#ann<-local(get(load("~/Downloads/covid19_cambridge_PLA_ANN.daE")))
ann = ann@obsDescr[[1]]

#matching the annotation file fo the LIPO_ANN file

ann<-ann[which(ann$sampleID %in% LIPO_ANN$sampleID),]
LIPO<- LIPO[which(LIPO_ANN$sampleID %in% ann$sampleID),]
LIPO_ANN<- LIPO_ANN[which(LIPO_ANN$sampleID %in% ann$sampleID),]

LIPO<- LIPO[match(ann$sampleID, LIPO_ANN$sampleID),]
LIPO_ANN<- LIPO_ANN[match(ann$sampleID, LIPO_ANN$sampleID),]

df<-cbind(LIPO, ann)
rm(ann, LIPO, LIPO_ANN)
```
#####remove samples with NA for age or group_facet_letter
```{r}
df2 <-
  df %>%
  filter(!is.na(age)) %>%
  filter(!is.na(group_facet_letter))%>%
  group_by(group_facet_letter, gender) 
```

#####check for inf values
```{r}
which(df2 == "Inf", arr.ind = TRUE)

#remove rows with Inf values for lipoprotein quantities
df3 <- df2[-c(49,70,548),]

rm(df, df2)
```

#tests pcagrid
```{r}
#usethis, usepackage, use vignette, list.re

loadPackages(myPackages = c("ggplot2",
                            "stats",
                            "roxygen2",
                            "testthat",
                            #"ggpmisc",
                            #"ggplotly",
                            #"plotly",
                            "tidyverse", 
                            #"ggpubr",
                            "GGally",
                            #"cowplot",
                            #"gridExtra",
                            #"rlist",
                            "ggrepel",
                            #"ellipse",
                            #"HotellingEllipse",
                            "sp"))
#1) create PCA object
a <- PCA(BIOspcglyc[,1:8])
a1 <- mva.plots::PCA(df3[,1:112], rank. = 20)

#2) 
fff<- plotScores(model=a, optns=list(color=BIOspcglyc[,"age"], shape=BIOspcglyc[,"sex"], ellipse="normal", outlierLabels=row.names(BIOspcglyc)))
fff[["plots"]][["pcaGrid"]]

fff1<- plotScores(model=a, optns=list(colour=BIOspcglyc[,"age"], shape=BIOspcglyc[,"sex"], PCi =1, PCj=2,ellipse="normal", outlierLabels=row.names(BIOspcglyc)))

#2)
fff<- plotLoadings(model= a)
fff[["plots"]][["plotLoadingGrid"]]
```


